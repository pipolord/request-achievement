#!/usr/bin/env node
"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o]);return r["default"]=e,r}function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function printLogs(e){var r=new _buildLogger2["default"](e);r.on("error",function(){console.log("> Connection error."),exit(1)}),r.on("close",function(){console.log(""+_chalk2["default"].cyan("> Deployment complete!")),exit(0)})}function handleError(e){error(403===e.status?"Authentication error. Run `now -L` or `now --login` to log-in again.":429===e.status?null!=e.retryAfter?"Rate limit exceeded error. Try again in "+(0,_ms2["default"])(1e3*e.retryAfter,{"long":!0})+", or upgrade your account: https://zeit.co/now#pricing":"Rate limit exceeded error. Please try later.":e.userError?e.message:500===e.status?"Unexpected server error. Please retry.":"Unexpected error. Please try later. ("+e.message+")"),exit(1)}function error(e){console.error("> [31mError![39m "+e)}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var o,t,n,a,i,c;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=Date.now(),console.log('> Deploying "'+path+'"'),t=new _lib2["default"](e,{debug:debug}),r.prev=3,r.next=6,t.create(path,{forceNew:force,forceSync:forceSync});case 6:r.next=12;break;case 8:return r.prev=8,r.t0=r["catch"](3),handleError(r.t0),r.abrupt("return");case 12:if(n=t.url,a=(0,_ms2["default"])(new Date-o),!clipboard){r.next=26;break}return r.prev=15,r.next=18,(0,_copy2["default"])(n);case 18:console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(n)+" (copied to clipboard) ["+a+"]"),r.next=24;break;case 21:r.prev=21,r.t1=r["catch"](15),console.log(_chalk2["default"].cyan("> Ready!")+" "+_chalk2["default"].bold(n)+" ["+a+"]");case 24:r.next=27;break;case 26:console.log("> "+n+" ["+a+"]");case 27:i=new Date,c=function(){var e=(0,_ms2["default"])(new Date-i);console.log("> Sync complete ("+(0,_bytes2["default"])(t.syncAmount)+") ["+e+"] "),t.close(),printLogs(t.host)},t.syncAmount?!function(){var e=new _progress2["default"]("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:t.syncAmount});t.upload(),t.on("upload",function(r){var o=r.name,t=r.data,n=t.length;debug&&console.log("> [debug] Uploaded: "+o+" ("+(0,_bytes2["default"])(t.length)+")"),e.tick(n)}),t.on("complete",c),t.on("error",function(e){error("Upload failed"),handleError(e),exit(1)})}():(console.log("> Sync complete (cached)"),t.close(),printLogs(t.host));case 30:case"end":return r.stop()}},r,this,[[3,8],[15,21]])}));return function(r){return e.apply(this,arguments)}}(),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_cfg=require("../lib/cfg"),cfg=_interopRequireWildcard(_cfg),_package=require("../../package"),_checkUpdate=require("../lib/check-update"),_checkUpdate2=_interopRequireDefault(_checkUpdate),_buildLogger=require("../lib/build-logger"),_buildLogger2=_interopRequireDefault(_buildLogger),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_minimist=require("minimist"),_minimist2=_interopRequireDefault(_minimist),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),argv=(0,_minimist2["default"])(process.argv.slice(2)),help=function(){console.log("\n  ùö´ now [options] <path>\n\n  Options:\n\n    -h, --help          output usage information\n    -v, --version       output the version number\n    -d, --debug         Debug mode [off]\n    -f, --force         Force a new deployment even if nothing has changed\n    -L, --login         Configure login\n    -C, --no-clipboard  Do not attempt to copy URL to clipboard\n")},path=argv._[0];path?"/"!==path[0]&&(path=(0,_path.resolve)(process.cwd(),path)):path=process.cwd();var debug=argv.debug||argv.d,clipboard=!(argv.noClipboard||argv.C),force=argv.f||argv.force,forceSync=argv.F||argv.forceSync,shouldLogin=argv.L||argv.login,config=cfg.read(),update=(0,_checkUpdate2["default"])({debug:debug}),exit=function(e){update.then(function(){return process.exit(e)}),setTimeout(function(){return process.exit(e)},1e3)};argv.h||argv.help?(help(),exit(0)):argv.v||argv.version?(console.log(_chalk2["default"].bold("ùö´ now"),_package.version),exit(0)):!config.token||shouldLogin?(0,_login2["default"])().then(function(e){shouldLogin?(console.log("> Logged in successfully. Token saved in ~/.now.json"),exit(0)):sync(e)["catch"](function(e){error("Unknown error: "+e.stack),exit(1)})})["catch"](function(e){error("Authentication error ‚Äì "+e.message),exit(1)}):sync(config.token)["catch"](function(e){error("Unknown error: "+e.stack),exit(1)});