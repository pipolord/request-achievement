"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_arrFlatten=require("arr-flatten"),_arrFlatten2=_interopRequireDefault(_arrFlatten),_arrayUnique=require("array-unique"),_arrayUnique2=_interopRequireDefault(_arrayUnique),_minimatch=require("minimatch"),_minimatch2=_interopRequireDefault(_minimatch),_ignored=require("./ignored"),_ignored2=_interopRequireDefault(_ignored),_path=require("path"),_fsPromise=require("fs-promise");exports["default"]=function(){function e(e,t,n){return r.apply(this,arguments)}var r=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e,r,n){var a,u,i,o,s,c,l=n.limit,f=void 0===l?null:l,p=n.debug,_=void 0===p?!1:p;return _regenerator2["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r){t.next=6;break}return a=(0,_path.resolve)(e,"package.json"),t.next=4,(0,_fsPromise.readFile)(a,"utf8");case 4:u=t.sent,r=JSON.parse(u);case 6:return i=(r.files||["."]).concat("package.json"),r.main&&(i=i.concat(r.main)),i=i.map(function(r){return asAbsolute(r,e)}),t.next=11,maybeRead((0,_path.resolve)(e,".npmignore"));case 11:if(o=t.sent,!o){t.next=16;break}t.t0="",t.next=19;break;case 16:return t.next=18,maybeRead((0,_path.resolve)(e,".gitignore"));case 18:t.t0=t.sent;case 19:return s=t.t0,c=(0,_arrayUnique2["default"])(_ignored2["default"].concat(s.split("\n").filter(invalidFilter)).concat(o.split("\n").filter(invalidFilter))).map(function(r){return(0,_path.resolve)(e,r)}),t.next=23,explode(i,c,{limit:f,debug:_});case 23:return t.t1=t.sent,t.abrupt("return",(0,_arrayUnique2["default"])(t.t1));case 25:case"end":return t.stop()}},t,this)}));return e}();var isIgnored=function(e,r){return r.some(function(r){var t=r+"/";return e.substr(0,t.length)===t?!0:(0,_minimatch2["default"])(e,r)})},invalidFilter=function(e){return!("#"===e[0]||!e.trim().length)},asAbsolute=function(e,r){return"/"===e[0]?e:(0,_path.resolve)(r,e)},explode=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,n){var a,u,i=this,o=n.limit,s=n.debug;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,_promise2["default"].all(e.map(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u(e);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}},r,i)}));return function(r){return e.apply(this,arguments)}}()));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}},r,i)}));return function(r){return e.apply(this,arguments)}}(),u=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var n,u,c;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n=e,u=void 0,r.prev=2,r.next=5,(0,_fsPromise.stat)(n);case 5:u=r.sent,r.next=20;break;case 8:return r.prev=8,r.t0=r["catch"](2),n=e+".js",r.prev=11,r.next=14,(0,_fsPromise.stat)(n);case 14:u=r.sent,r.next=20;break;case 17:return r.prev=17,r.t1=r["catch"](11),r.abrupt("return",null);case 20:if(!isIgnored(e,t)){r.next=23;break}return s&&console.log('> [debug] Ignoring "'+e+'"'),r.abrupt("return",null);case 23:if(!u.isDirectory()){r.next=30;break}return r.next=26,(0,_fsPromise.readdir)(e);case 26:return c=r.sent,r.abrupt("return",a(c.map(function(r){return asAbsolute(r,e)})));case 30:if(!(null!=o&&u.size>o)){r.next=33;break}return console.error("> [31mWarning![39m Skipping file "+("over "+(0,_bytes2["default"])(o)+": "+n)),r.abrupt("return",null);case 33:return r.abrupt("return",n);case 34:case"end":return r.stop()}},r,i,[[2,8],[11,17]])}));return function(r){return e.apply(this,arguments)}}(),r.next=4,a(e);case 4:return r.t0=r.sent,r.t1=function(e){return null!=e},r.abrupt("return",(0,_arrFlatten2["default"])(r.t0).filter(r.t1));case 7:case"end":return r.stop()}},r,this)}));return function(r,t,n){return e.apply(this,arguments)}}(),maybeRead=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,_fsPromise.readFile)(e,"utf8");case 3:return r.abrupt("return",r.sent);case 6:return r.prev=6,r.t0=r["catch"](0),r.abrupt("return","");case 9:case"end":return r.stop()}},r,this,[[0,6]])}));return function(r){return e.apply(this,arguments)}}();